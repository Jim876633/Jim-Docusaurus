<!doctype html><html lang=zh-Hant-TW dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-react/zustand-source-code" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>【React】從 zustand 原始碼了解狀態管理 | Jim's notes</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://jimhuang.dev/react/zustand-source-code><meta data-rh=true property=og:locale content=zh_Hant-TW><meta data-rh=true name=docusaurus_locale content=zh-Hant-TW><meta data-rh=true name=docsearch:language content=zh-Hant-TW><meta data-rh=true name=google-site-verification content=Xow6fHBMZxltxfkcAm44dklblf6FUas98iNOJ1QhcKg><meta data-rh=true name="Jim's Blog" content="Jim docusaurus blog"><meta data-rh=true name=robots content=max-image-preview:large><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="【React】從 zustand 原始碼了解狀態管理 | Jim's notes "><meta data-rh=true name=description content="Zustand 的介紹可以先看這篇，這一篇主要是透過閱讀 zustand 的原始碼來了解它的運作原理。會想要寫這篇是因為使用套件大家都已經習以為常，但套件到底幫我們做了什麼事相信大部分的人（包括我）平常是不會特別去了解的，想要看套件的原始碼，很多又太艱澀難以咀嚼。"><meta data-rh=true property=og:description content="Zustand 的介紹可以先看這篇，這一篇主要是透過閱讀 zustand 的原始碼來了解它的運作原理。會想要寫這篇是因為使用套件大家都已經習以為常，但套件到底幫我們做了什麼事相信大部分的人（包括我）平常是不會特別去了解的，想要看套件的原始碼，很多又太艱澀難以咀嚼。"><link data-rh=true rel=icon href=/img/favicon-32x32.png><link data-rh=true rel=canonical href=https://jimhuang.dev/react/zustand-source-code><link data-rh=true rel=alternate href=https://jimhuang.dev/react/zustand-source-code hreflang=zh-Hant-TW><link data-rh=true rel=alternate href=https://jimhuang.dev/react/zustand-source-code hreflang=x-default><link data-rh=true rel=preconnect href=https://SFNWCB64WA-dsn.algolia.net crossorigin=anonymous><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=G-PW7J7LMHR0"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-PW7J7LMHR0",{anonymize_ip:!0})</script><link rel=search type=application/opensearchdescription+xml title="Jim's notes " href=/opensearch.xml><link rel=stylesheet href=/assets/css/styles.7cefd60b.css><script src=/assets/js/runtime~main.16ca0f74.js defer></script><script src=/assets/js/main.fc232c33.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":(window.matchMedia("(prefers-color-scheme: light)").matches,"light"),document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label=跳至主要内容><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>跳至主要内容</a></div><nav aria-label=主導航 class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class=navbar__inner><div class=navbar__items><button aria-label=切換導覽列 aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/logo-small.png alt="Jim's logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/logo-darkmode-small.png alt="Jim's logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Jim's note</b></a><a class="navbar__item navbar__link" href=/interview/intro>📚 Frontend Q&A</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/tags>📌 Tag</a><a class="navbar__item navbar__link" href=/changelog>⏳ Changelog</a><a href=https://github.com/Jim876633 target=_blank rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository" title=GitHub></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title=切換淺色/深色模式（當前為淺色模式） aria-label=切換淺色/深色模式（當前為淺色模式） aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1><button type=button class="DocSearch DocSearch-Button" aria-label="搜尋 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>搜尋</span></span><span class=DocSearch-Button-Keys></span></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label=回到頂部 class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex=-1 class=sidebarLogo_isFc href=/><img src=/img/logo-small.png alt="Jim's logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/logo-darkmode-small.png alt="Jim's logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b>Jim's note</b></a><nav aria-label=文件側邊欄 class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/>Intro</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/category/react>React</a><button aria-label="收起側邊欄分類 'React'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/react/router>React router (v6)</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/react/zustand>Zustand</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/react/zustand-source-code>Zustand 原始碼解析</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/typescript>TypeScript</a><button aria-label="展開側邊欄分類 'TypeScript'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/docusaurus>Docusaurus</a><button aria-label="展開側邊欄分類 'Docusaurus'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/css>CSS</a><button aria-label="展開側邊欄分類 'CSS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/mac>Mac</a><button aria-label="展開側邊欄分類 'Mac'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/node>Node</a><button aria-label="展開側邊欄分類 'Node'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/tips>Tips</a><button aria-label="展開側邊欄分類 'Tips'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/vue>Vue</a><button aria-label="展開側邊欄分類 'Vue'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/git>Git</a><button aria-label="展開側邊欄分類 'Git'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/javascript>JavaScript</a><button aria-label="展開側邊欄分類 'JavaScript'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/npm>Npm</a><button aria-label="展開側邊欄分類 'Npm'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/unit-test>Unit Test</a><button aria-label="展開側邊欄分類 'Unit Test'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/other>Other</a><button aria-label="展開側邊欄分類 'Other'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/2023-ithome>2023 鐵人賽</a><button aria-label="展開側邊欄分類 '2023 鐵人賽'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/category/interview>Interview</a><button aria-label="展開側邊欄分類 'Interview'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav><button type=button title=收起側邊欄 aria-label=收起側邊欄 class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_z5aJ"><div class=docItemContainer_c0TR><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=頁面路徑><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label=主頁面 class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/category/react><span itemprop=name>React</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Zustand 原始碼解析</span><meta itemprop=position content=2></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>【React】從 zustand 原始碼了解狀態管理</h1></header><p>Zustand 的介紹可以先看<a href=/react/zustand>這篇</a>，這一篇主要是透過閱讀 zustand 的原始碼來了解它的運作原理。會想要寫這篇是因為使用套件大家都已經習以為常，但套件到底幫我們做了什麼事相信大部分的人（包括我）平常是不會特別去了解的，想要看套件的原始碼，很多又太艱澀難以咀嚼。</p>
<p>而 zustnad 就是一個很好入門的套件，它的原始碼不多，大部分都蠻容易看懂（撇除 Typescript 的部分），看完也會讓你對狀態管理有更深的了解，可以說是初次閱讀原始碼的好選擇，就讓我們來好好了解 zustand 是如何做到 React 狀態管理吧！</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=原始碼解析>原始碼解析<a href=#原始碼解析 class=hash-link aria-label=原始碼解析的直接連結 title=原始碼解析的直接連結>​</a></h2>
<p>zustand 的核心原始碼主要是在 <code>src</code> 底下的 <code>react.ts</code> 以及 <code>vanilla.ts</code> 這兩支檔案，這邊以 <a href=https://github.com/pmndrs/zustand/tree/v4.5.1/src target=_blank rel="noopener noreferrer">v4.5.1</a> 的版本為例。</p>
<img src=/assets/images/code-file-4a7bb04c29b0d8b5f6310c4bb01dd530.jpg style="width:min(100%,300px);display:block;margin:0 auto;border-radius:5px"><br><br>
<p>而這兩支檔案總共有三個主要的 function:</p>
<ol>
<li><code>create</code> (react.ts)：zustand 的核心 function，用來建立 store。</li>
<li><code>useStore</code> (react.ts)：處理同步 React 內部及外部的 state 狀態。</li>
<li><code>createStore</code> (vanilla.ts)：建立全域的 state 及建立訂閱模式。</li>
</ol>
<p>他們之間的關聯性會像這樣：</p>
<img src=/assets/images/code-structure-d528a79991b1c4b34239ba2e79af9536.jpg style=width:min(100%,100%);display:inline-block;margin:0;border-radius:5px><br><br>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=create-reactts>create (react.ts)<a href=#create-reactts class=hash-link aria-label="create (react.ts)的直接連結" title="create (react.ts)的直接連結">​</a></h3>
<p>首先來看一下 <a href=https://github.com/pmndrs/zustand/blob/6109bc3bd0f3850c2d9546956de971f27834ac7a/src/react.ts#L124 target=_blank rel="noopener noreferrer">create</a> 的部分：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>export</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> create </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token constant" style=color:#5a9bcf>T</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StateCreator</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token constant" style=color:#5a9bcf>T</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>[</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>[</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token operator" style=color:#d7deea>></span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>|</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>undefined</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  createState </span><span class="token operator" style=color:#d7deea>?</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>createImpl</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> createImpl</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>as</span><span class="token plain"> Create</span><span class="token punctuation" style=color:#8dc891>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>他回傳了一個 <code>createImpl</code> 的 function，這個 function 定義了一個叫 api 的物件，是呼叫 <code>createStore</code> 的回傳值。</p>
<p>然後建立一個 <code>useBoundStore</code> 的 function，這個 function 會回傳 <code>useStore</code> ，並且把 api 物件傳入 <code>useStore</code>。</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> createImpl </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token constant" style=color:#5a9bcf>T</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StateCreator</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token constant" style=color:#5a9bcf>T</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>[</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>[</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>import</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">meta</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">env</span><span class="token operator" style=color:#d7deea>?.</span><span class="token constant" style=color:#5a9bcf>MODE</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>!==</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"production"</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>&&</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>typeof</span><span class="token plain"> createState </span><span class="token operator" style=color:#d7deea>!==</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"function"</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token builtin" style=color:#D8DEE9>console</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>warn</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">      </span><span class="token string" style=color:#8dc891>"[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`."</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> api </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>typeof</span><span class="token plain"> createState </span><span class="token operator" style=color:#d7deea>===</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"function"</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>?</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>createStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> createState</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> useBoundStore</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token function-variable function" style=color:#79b6f2>any</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">selector</span><span class="token operator" style=color:#d7deea>?</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token builtin" style=color:#D8DEE9>any</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> equalityFn</span><span class="token operator" style=color:#d7deea>?</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token builtin" style=color:#D8DEE9>any</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    </span><span class="token function" style=color:#79b6f2>useStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">api</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> selector</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> equalityFn</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  Object</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>assign</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">useBoundStore</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> api</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> useBoundStore</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=createstore-vanillats>createStore (vanilla.ts)<a href=#createstore-vanillats class=hash-link aria-label="createStore (vanilla.ts)的直接連結" title="createStore (vanilla.ts)的直接連結">​</a></h3>
<p>接著來看一下 <a href=https://github.com/pmndrs/zustand/blob/6109bc3bd0f3850c2d9546956de971f27834ac7a/src/vanilla.ts#L109 target=_blank rel="noopener noreferrer">createStore</a>：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>export</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> createStore </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  createState </span><span class="token operator" style=color:#d7deea>?</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>createStoreImpl</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> createStoreImpl</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>as</span><span class="token plain"> CreateStore</span><span class="token punctuation" style=color:#8dc891>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>一樣回傳了一個 <code>createStoreImpl</code> 的 fucntion：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> createStoreImpl</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token function-variable function" style=color:#79b6f2>CreateStoreImpl</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>type</span><span class="token plain"> </span><span class="token class-name" style=color:#FAC863>TState</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> ReturnType</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token keyword" style=color:#c5a5c5>typeof</span><span class="token plain"> createState</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>type</span><span class="token plain"> </span><span class="token class-name" style=color:#FAC863>Listener</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">state</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> TState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> prevState</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> TState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>void</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>let</span><span class="token plain"> state</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> TState</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> listeners</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> Set</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token plain">Listener</span><span class="token operator" style=color:#d7deea>></span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>new</span><span class="token plain"> </span><span class="token class-name" style=color:#FAC863>Set</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> setState</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StoreApi</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token plain">TState</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>[</span><span class="token string" style=color:#8dc891>"setState"</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">partial</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> replace</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token comment" style=color:#999999>// TODO: Remove type assertion once https://github.com/microsoft/TypeScript/issues/37663 is resolved</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token comment" style=color:#999999>// https://github.com/microsoft/TypeScript/issues/37663#issuecomment-759728342</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> nextState </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">      </span><span class="token keyword" style=color:#c5a5c5>typeof</span><span class="token plain"> partial </span><span class="token operator" style=color:#d7deea>===</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"function"</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">        </span><span class="token operator" style=color:#d7deea>?</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">partial </span><span class="token keyword" style=color:#c5a5c5>as</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">state</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> TState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> TState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">state</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">        </span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> partial</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token operator" style=color:#d7deea>!</span><span class="token plain">Object</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token keyword" style=color:#c5a5c5>is</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">nextState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> state</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">      </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> previousState </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> state</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">      state </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">        replace </span><span class="token operator" style=color:#d7deea>??</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token keyword" style=color:#c5a5c5>typeof</span><span class="token plain"> nextState </span><span class="token operator" style=color:#d7deea>!==</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"object"</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>||</span><span class="token plain"> nextState </span><span class="token operator" style=color:#d7deea>===</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>null</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">          </span><span class="token operator" style=color:#d7deea>?</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">nextState </span><span class="token keyword" style=color:#c5a5c5>as</span><span class="token plain"> TState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">          </span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> Object</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>assign</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>{</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> state</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> nextState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">      listeners</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>forEach</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">listener</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>listener</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">state</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> previousState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> getState</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StoreApi</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token plain">TState</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>[</span><span class="token string" style=color:#8dc891>"getState"</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> state</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> getInitialState</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StoreApi</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token plain">TState</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>[</span><span class="token string" style=color:#8dc891>"getInitialState"</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    initialState</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> subscribe</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StoreApi</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token plain">TState</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>[</span><span class="token string" style=color:#8dc891>"subscribe"</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">listener</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    listeners</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>add</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">listener</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    </span><span class="token comment" style=color:#999999>// Unsubscribe</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> listeners</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>delete</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">listener</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> destroy</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StoreApi</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token plain">TState</span><span class="token operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>[</span><span class="token string" style=color:#8dc891>"destroy"</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token keyword" style=color:#c5a5c5>import</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">meta</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">env</span><span class="token operator" style=color:#d7deea>?.</span><span class="token constant" style=color:#5a9bcf>MODE</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>!==</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"production"</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">      </span><span class="token builtin" style=color:#D8DEE9>console</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>warn</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">        </span><span class="token string" style=color:#8dc891>"[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">      </span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    listeners</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>clear</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> api </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"> setState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> getState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> getInitialState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> subscribe</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> destroy </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> initialState </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">state </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>createState</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">setState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> getState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> api</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> api </span><span class="token keyword" style=color:#c5a5c5>as</span><span class="token plain"> </span><span class="token builtin" style=color:#D8DEE9>any</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>首先可以看到他宣告了一個 <code>state</code> 變數，這個變數是用來存放全域的 state 值，然後建立了一個 <code>listeners</code> 的 Set 物件，用來存放訂閱的 function。</p>
<p>createStore 的重點在於他建立了與訂閱模式相關的 function：</p>
<ul>
<li><code>setState</code>：用來更新 state 的 function。</li>
<li><code>getState</code>：取得目前的 state。</li>
<li><code>getInitialState</code>：取得初始的 state。</li>
<li><code>subscribe</code>：訂閱 state 的變化。</li>
<li><code>destroy</code>：銷毀訂閱。</li>
</ul>
<p><code>getState</code> 跟 <code>getInitialState</code> 都蠻好理解的，就是取得目前的 state 跟初始的 state。
<code>setState</code> 有做一層判斷，如果新的值跟舊的值不同（使用 Object.is 判斷），就會去 forEach listeners 裡面儲存的所有 function，這些 function 我稱之為<span class="highlight-yellow highlight" style=font-weight:normal>更新函式</span>，後面會再說明更新函式是什麼。
<code>subscribe</code> 就是把更新函式加入 listeners 裡面，並且回傳一個 function 用來取消訂閱。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=usestore-reactts>useStore (react.ts)<a href=#usestore-reactts class=hash-link aria-label="useStore (react.ts)的直接連結" title="useStore (react.ts)的直接連結">​</a></h3>
<p>最後一個 function 是 <a href=https://github.com/pmndrs/zustand/blob/6109bc3bd0f3850c2d9546956de971f27834ac7a/src/react.ts#L53 target=_blank rel="noopener noreferrer">useStore</a> 可以說是 zustand 的核心 function：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>export</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>function</span><span class="token plain"> </span><span class="token generic-function function" style=color:#79b6f2>useStore</span><span class="token generic-function generic class-name operator" style=color:#d7deea>&lt;</span><span class="token generic-function generic class-name" style=color:#FAC863>TState</span><span class="token generic-function generic class-name punctuation" style=color:#8dc891>,</span><span class="token generic-function generic class-name" style=color:#FAC863> StateSlice</span><span class="token generic-function generic class-name operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  api</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> WithReact</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token plain">StoreApi</span><span class="token operator" style=color:#d7deea>&lt;</span><span class="token plain">TState</span><span class="token operator" style=color:#d7deea>>></span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token function-variable function" style=color:#79b6f2>selector</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">state</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> TState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> StateSlice </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> identity </span><span class="token keyword" style=color:#c5a5c5>as</span><span class="token plain"> </span><span class="token builtin" style=color:#D8DEE9>any</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  equalityFn</span><span class="token operator" style=color:#d7deea>?</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">a</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StateSlice</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> b</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> StateSlice</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token builtin" style=color:#D8DEE9>boolean</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>import</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">meta</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">env</span><span class="token operator" style=color:#d7deea>?.</span><span class="token constant" style=color:#5a9bcf>MODE</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>!==</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"production"</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>&&</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    equalityFn </span><span class="token operator" style=color:#d7deea>&&</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token operator" style=color:#d7deea>!</span><span class="token plain">didWarnAboutEqualityFn</span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token builtin" style=color:#D8DEE9>console</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>warn</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">      </span><span class="token string" style=color:#8dc891>"[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    didWarnAboutEqualityFn </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token boolean" style=color:#ff8b50>true</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> slice </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>useSyncExternalStoreWithSelector</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    api</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">subscribe</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    api</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">getState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    api</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">getServerState </span><span class="token operator" style=color:#d7deea>||</span><span class="token plain"> api</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">getInitialState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    selector</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    equalityFn</span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token function" style=color:#79b6f2>useDebugValue</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">slice</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> slice</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>他把剛剛建立的 <code>getState</code> 跟 <code>subscribe</code> 傳入 <code>useSyncExternalStoreWithSelector</code>，並回傳了它的結果。</p>
<p>那這個 <code>useSyncExternalStoreWithSelector</code> 又是怎麼辦到的呢？這就要提到 react 18 新增的 hook <a href=https://ru.react.dev/reference/react/useSyncExternalStore target=_blank rel="noopener noreferrer">useSyncExternalStore</a>。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=usesyncexternalstore>useSyncExternalStore<a href=#usesyncexternalstore class=hash-link aria-label=useSyncExternalStore的直接連結 title=useSyncExternalStore的直接連結>​</a></h3>
<p><code>useSyncExternalStore</code> 是 react 18 新增的 hook，用來同步 React 內部及外部的 state 狀態。這是什麼意思呢？我們都知道 React 在更新 UI 畫面時，會透過 useState 來更新 state，並進行 re-render，但如果我今天不想用 useState 想要隨便建立一個物件儲存 state，那我要怎麼告訴 React 這個物件底下的值改變時，幫我重新進行畫面更新呢？這就是 <code>useSyncExternalStore</code> 的作用拉！</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> snapshot </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>useSyncExternalStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  subscribe</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  getSnapshot</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  getServerSnapshot</span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>會傳入三個參數：</p>
<ul>
<li><code>subscribe</code>：訂閱 state 的變化。</li>
<li><code>getSnapshot</code>：取得當前最新的值。</li>
<li><code>getServerSnapshot</code>：取得 SSR 的初始狀態（可選）。</li>
</ul>
<p>而因為這個 hook 是 React 18 新增的，所以為了讓之前的版本也可以做使用，所以有另外把這個 hook 拉出一個獨立的 package <a href=https://www.npmjs.com/package/use-sync-external-store target=_blank rel="noopener noreferrer">use-sync-external-store</a>，透過這個 package 的原始碼，我們可以一窺究竟這個 hook 大概是怎麼實作的。</p>
<img src=/assets/images/use-sync-external-store-aae6c790b92b767f751ea0c7a3aff8c2.jpg style=width:min(100%,100%);display:inline-block;margin:0;border-radius:5px><br><br>
<p>原始碼位置是在 react package 底下的 <a href=https://github.com/facebook/react/blob/main/packages/use-sync-external-store/src/useSyncExternalStoreShimClient.js target=_blank rel="noopener noreferrer">useSyncExternalStoreShimClient.js</a> 裡面，這邊只列出重點程式碼：</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>export</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>function</span><span class="token plain"> </span><span class="token generic-function function" style=color:#79b6f2>useSyncExternalStore</span><span class="token generic-function generic class-name operator" style=color:#d7deea>&lt;</span><span class="token generic-function generic class-name constant" style=color:#5a9bcf>T</span><span class="token generic-function generic class-name operator" style=color:#d7deea>></span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token function-variable function" style=color:#79b6f2>subscribe</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>void</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>void</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token function-variable function" style=color:#79b6f2>getSnapshot</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token constant" style=color:#5a9bcf>T</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  getServerSnapshot</span><span class="token operator" style=color:#d7deea>?</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token constant" style=color:#5a9bcf>T</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>)</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token constant" style=color:#5a9bcf>T</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> value </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>getSnapshot</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>[</span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain">inst</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> forceUpdate</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>useState</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain">inst</span><span class="token operator" style=color:#d7deea>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain">value</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> getSnapshot</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token function" style=color:#79b6f2>useEffect</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token function" style=color:#79b6f2>checkIfSnapshotChanged</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">inst</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">      </span><span class="token function" style=color:#79b6f2>forceUpdate</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain">inst</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#79b6f2>handleStoreChange</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">      </span><span class="token keyword" style=color:#c5a5c5>if</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token function" style=color:#79b6f2>checkIfSnapshotChanged</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">inst</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">        </span><span class="token function" style=color:#79b6f2>forceUpdate</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain">inst</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">      </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">    </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>subscribe</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">handleStoreChange</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>[</span><span class="token plain">subscribe</span><span class="token punctuation" style=color:#8dc891>]</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token function" style=color:#79b6f2>useDebugValue</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">value</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> value</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>可以看到其實是透過 useState 及 useEffect 來達成的，useState 的部分是為了讓 React 重新 render，他實作了一個強制更新的方法，因為他每次 setState 的時候都是傳入一個新的物件，而 React 內部在判斷是否要 re-render 時，兩個物件會判定為不同，所以就會重新 render。</p>
<p>而在 useEffect 的部分，它建立了一個 <code>handleStoreChange</code> 的 function，裡面會先判斷目前的值是否有改變，如果有改變就會呼叫 <code>forceUpdate</code> 來進行強制更新，而這個 <code>handleStoreChange</code> 也就是我們前面說的 <span class="highlight-yellow highlight" style=font-weight:normal>更新函式</span>，最後透過 <code>subscribe</code> 把這個 function 加入 listeners 裡面。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=zustand-內部訂閱流程圖>zustand 內部訂閱流程圖<a href=#zustand-內部訂閱流程圖 class=hash-link aria-label="zustand 內部訂閱流程圖的直接連結" title="zustand 內部訂閱流程圖的直接連結">​</a></h3>
<p>下面是<span class="highlight-yellow highlight" style=font-weight:normal>更新函式</span>被加進 listeners 的流程：</p>
<img src=/assets/images/update-flow-967b6b62d20ac5e7a3302f0cebca6867.gif style="width:min(100%,700px);display:block;margin:0 auto;border-radius:5px"><br><br>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=zustand-更新-state-流程圖>zustand 更新 state 流程圖<a href=#zustand-更新-state-流程圖 class=hash-link aria-label="zustand 更新 state 流程圖的直接連結" title="zustand 更新 state 流程圖的直接連結">​</a></h3>
<p>接下來讓我們來看一下如果今天有多個元件使用了同一個 zustand 的 state 時，是如何進行更新的。現在有兩個元件</p>
<img src=/assets/images/counter-two-component-1f91b996c01e9dff93c6bfcfb8a8cf22.gif style="width:min(100%,350px);display:block;margin:0 auto;border-radius:5px"><br><br>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockTitle_Ktv7>Counter.js</div><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword module" style=color:#c5a5c5>import</span><span class="token plain"> </span><span class="token imports punctuation" style=color:#8dc891>{</span><span class="token imports"> useCountStore </span><span class="token imports punctuation" style=color:#8dc891>}</span><span class="token plain"> </span><span class="token keyword module" style=color:#c5a5c5>from</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"./store"</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token keyword module" style=color:#c5a5c5>export</span><span class="token plain"> </span><span class="token keyword module" style=color:#c5a5c5>default</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>function</span><span class="token plain"> </span><span class="token function maybe-class-name" style=color:#79b6f2>Counter</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"> count</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> increment</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> decrement </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>useCountStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword control-flow" style=color:#c5a5c5>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token tag punctuation" style=color:#8dc891>&lt;</span><span class="token tag" style=color:#fc929e>div</span><span class="token tag" style=color:#fc929e> </span><span class="token tag attr-name" style=color:#c5a5c5>className</span><span class="token tag attr-value punctuation attr-equals" style=color:#8dc891>=</span><span class="token tag attr-value punctuation" style=color:#8dc891>'</span><span class="token tag attr-value" style=color:#8dc891>counter</span><span class="token tag attr-value punctuation" style=color:#8dc891>'</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain-text">      </span><span class="token tag punctuation" style=color:#8dc891>&lt;</span><span class="token tag" style=color:#fc929e>button</span><span class="token tag" style=color:#fc929e> </span><span class="token tag attr-name" style=color:#c5a5c5>onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style=color:#8dc891>=</span><span class="token tag script language-javascript punctuation" style=color:#8dc891>{</span><span class="token tag script language-javascript" style=color:#fc929e>decrement</span><span class="token tag script language-javascript punctuation" style=color:#8dc891>}</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text">-</span><span class="token tag punctuation" style=color:#8dc891>&lt;/</span><span class="token tag" style=color:#fc929e>button</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain-text">      </span><span class="token tag punctuation" style=color:#8dc891>&lt;</span><span class="token tag" style=color:#fc929e>h1</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain">count</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token tag punctuation" style=color:#8dc891>&lt;/</span><span class="token tag" style=color:#fc929e>h1</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain-text">      </span><span class="token tag punctuation" style=color:#8dc891>&lt;</span><span class="token tag" style=color:#fc929e>button</span><span class="token tag" style=color:#fc929e> </span><span class="token tag attr-name" style=color:#c5a5c5>onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style=color:#8dc891>=</span><span class="token tag script language-javascript punctuation" style=color:#8dc891>{</span><span class="token tag script language-javascript" style=color:#fc929e>increment</span><span class="token tag script language-javascript punctuation" style=color:#8dc891>}</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text">+</span><span class="token tag punctuation" style=color:#8dc891>&lt;/</span><span class="token tag" style=color:#fc929e>button</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain-text">    </span><span class="token tag punctuation" style=color:#8dc891>&lt;/</span><span class="token tag" style=color:#fc929e>div</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockTitle_Ktv7>Total.js</div><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword module" style=color:#c5a5c5>import</span><span class="token plain"> </span><span class="token imports punctuation" style=color:#8dc891>{</span><span class="token imports"> useCountStore </span><span class="token imports punctuation" style=color:#8dc891>}</span><span class="token plain"> </span><span class="token keyword module" style=color:#c5a5c5>from</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"./store"</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token keyword module" style=color:#c5a5c5>export</span><span class="token plain"> </span><span class="token keyword module" style=color:#c5a5c5>default</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>function</span><span class="token plain"> </span><span class="token function maybe-class-name" style=color:#79b6f2>Total</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"> count </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>useCountStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword control-flow" style=color:#c5a5c5>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token tag punctuation" style=color:#8dc891>&lt;</span><span class="token tag" style=color:#fc929e>div</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain-text">      </span><span class="token tag punctuation" style=color:#8dc891>&lt;</span><span class="token tag" style=color:#fc929e>h1</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text">Total Count: </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain">count</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token tag punctuation" style=color:#8dc891>&lt;/</span><span class="token tag" style=color:#fc929e>h1</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain-text"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain-text">    </span><span class="token tag punctuation" style=color:#8dc891>&lt;/</span><span class="token tag" style=color:#fc929e>div</span><span class="token tag punctuation" style=color:#8dc891>></span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>這兩個元件都呼叫了 <code>useCountStore</code> 來取得 count 的值，前面提到 <code>useCountStore</code>
會呼叫 <code>useSyncExternalStore</code> 來把 <span class="highlight-yellow highlight" style=font-weight:normal>更新函式</span> 加入到 listeners
裡面，所以當畫面渲染時，listeners 會有兩個 updator 函式，而當 Counter 呼叫了 <code>increment</code> 或 <code>decrement</code> 時，會觸發 zustand
內部的 <code>setState</code>，這時候會先更新 state 的值，然後執行 listeners 裡面的所有 updator
函式，這樣就會讓所有使用了這個 state 的元件都重新 render。</p>
<img src=/assets/images/muti-component-flow-4f3d858786b3f0a399ad53c916acecd8.gif style="width:min(100%,100%);display:block;margin:0 auto;border-radius:5px"><br><br>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=zustand-濃縮版>zustand 濃縮版<a href=#zustand-濃縮版 class=hash-link aria-label="zustand 濃縮版的直接連結" title="zustand 濃縮版的直接連結">​</a></h2>
<p>如果把 zustand 的原始碼只保留核心功能，會變成這樣：</p>
<ol>
<li>create</li>
</ol>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>export</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#79b6f2>create</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> api </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>createStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>useStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">api</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<ol start=2>
<li>createStore</li>
</ol>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#79b6f2>createStore</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">createState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>let</span><span class="token plain"> state </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> listeners </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>new</span><span class="token plain"> </span><span class="token class-name" style=color:#FAC863>Set</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#79b6f2>setState</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">partial</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> nextState </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>partial</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">state</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    state </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>...</span><span class="token plain">state</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>...</span><span class="token plain">nextState </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    listeners</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>forEach</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">listener</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>listener</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#79b6f2>getState</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> state</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> </span><span class="token function-variable function" style=color:#79b6f2>subscribe</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">listener</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    listeners</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>add</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">listener</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">    </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>(</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token operator" style=color:#d7deea>=></span><span class="token plain"> listeners</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token function" style=color:#79b6f2>delete</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">listener</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  state </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>createState</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">setState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> api </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"> setState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> getState</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> subscribe </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> api</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><span class="token punctuation" style=color:#8dc891>;</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<ol start=3>
<li>useStore</li>
</ol>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style=--prism-background-color:#282c34;--prism-color:#ffffff><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style=background-color:#282c34;color:#ffffff><code class=codeBlockLines_e6Vv><span class=token-line style=color:#ffffff><span class="token keyword" style=color:#c5a5c5>import</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"> useSyncExternalStore </span><span class="token punctuation" style=color:#8dc891>}</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>from</span><span class="token plain"> </span><span class="token string" style=color:#8dc891>"react"</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token keyword" style=color:#c5a5c5>export</span><span class="token plain"> </span><span class="token keyword" style=color:#c5a5c5>function</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>useStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">api</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#8dc891>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>const</span><span class="token plain"> entireState </span><span class="token operator" style=color:#d7deea>=</span><span class="token plain"> </span><span class="token function" style=color:#79b6f2>useSyncExternalStore</span><span class="token punctuation" style=color:#8dc891>(</span><span class="token plain">api</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">subscribe</span><span class="token punctuation" style=color:#8dc891>,</span><span class="token plain"> api</span><span class="token punctuation" style=color:#8dc891>.</span><span class="token plain">getState</span><span class="token punctuation" style=color:#8dc891>)</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#ffffff><span class="token plain">  </span><span class="token keyword" style=color:#c5a5c5>return</span><span class="token plain"> entireState</span><span class="token punctuation" style=color:#8dc891>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#ffffff><span class="token plain"></span><span class="token punctuation" style=color:#8dc891>}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=複製程式碼至剪貼簿 title=複製 class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=zustand-架構模式>zustand 架構模式<a href=#zustand-架構模式 class=hash-link aria-label="zustand 架構模式的直接連結" title="zustand 架構模式的直接連結">​</a></h2>
<p>Zustand 的在 <a href=https://docs.pmnd.rs/zustand/guides/flux-inspired-practice target=_blank rel="noopener noreferrer">Flux inspired practice</a> 有提到：</p>
<blockquote>
<p>Although Zustand is an unopinionated library, we do recommend a few patterns. These are inspired by practices originally found in Flux, and more recently Redux, so if you are coming from another library, you should feel right at home.</p>
</blockquote>
<p>意思是 Zustand 本身並沒有強制要求使用者遵循任何特定的架構模式，但是建議使用者可以參考 Flux 或 Redux 的一些實踐方式。Redux 在學 React 的時候應該都有聽過，那這個 <strong>Flux</strong> 是什麼呢？</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=flux>Flux<a href=#flux class=hash-link aria-label=Flux的直接連結 title=Flux的直接連結>​</a></h3>
<p>Flux 是一種架構模式，那什麼是架構模式呢？比較常聽到的例子就是 MVC，架構模式的目的是用來幫助我們可以更好的組織程式碼，讓程式碼更加容易維護、擴充。而 Flux 則是從 MVC 所啟發出來的一種架構模式。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>MVC</div><div class=admonitionContent_BuS1><p>MVC 模式最早由 Trygve Reenskaug 在 1978 年提出，並且在 University of Oslo 有留下<a href="https://www.duo.uio.no/bitstream/handle/10852/9621/Reenskaug-MVC.pdf?sequence=1&isAllowed=y" target=_blank rel="noopener noreferrer">研究報告</a>，他把應用程式分為三個部分：<ol>
<li>Model: 負責處理資料</li>
<li>View: 負責顯示畫面</li>
<li>Controller: 負責處理 View 的事件，也會說是 View 及 Model 之間的橋樑</li>
</ol><p>MVC 的好處是可以讓程式碼更加模組化，每個部分都有自己的責任，不會互相干擾，也讓程式碼更容易維護。</div></div>
<p>雖然 MVC 的架構定義了三個部分的職責，不過對於三個部分之間的溝通方式並沒有明確的定義，所以在實際應用時，可能會有不同的實作方式，這也是為什麼有很多不同的 MVC 變體，像是 MVP、MVVM 等等，而 Flux 的出現就是為了解決 MVC 在資料流上不好追蹤的問題。</p>
<p>Flux 是 React 在 2014 年的 <a href="https://www.youtube.com/watch?v=nYkdrAPrdcw&ab_channel=MetaDevelopers" target=_blank rel="noopener noreferrer">Hacker Way conference</a> 上提出的概念，為的就是解決 Facebook 在使用 MVC 架構所遇到的問題。Facebook 最初是使用雙向綁定的方式進行資料傳遞，但隨著專案越來越大，資料流變得越來越複雜。</p>
<img src=/assets/images/mvc-problem-6c68826c5322aefe4d904b59e31f7cb3.jpg style=width:min(100%,100%);display:inline-block;margin:0;border-radius:5px><br><br>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>小爭議</div><div class=admonitionContent_BuS1><p>這張圖在當時引起不少的<a href=https://www.reddit.com/r/programming/comments/25nrb5/facebook_mvc_does_not_scale_use_flux_instead/ target=_blank rel="noopener noreferrer">討論</a>，有人認為 facebook 的 MVC 圖是錯的，真正的 MVC 才不會只有一個 controller，也有人認為 Flux 根本只是 MVC 換個名詞。<p>而當時的演講者 Jing Chen 也有出來<a href="https://www.reddit.com/r/programming/comments/25nrb5/comment/chjbo05/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button" target=_blank rel="noopener noreferrer">說明</a>，這張圖的確是有點投機取巧，不過重點還是在於雙向資料流所造成的問題，而 Flux 中的 dispatcher 並不等同於 controller，他只是一個分發 action 的 callback 來達成單向資料流的目的。</div></div>
<p>meta 工程師舉的實際例子是當初做 message chat 的時候，一開始只有一個區塊跟訊息有關，但後來越來越多功能會對訊息的數量造成影響。</p>
<p>而遇到的 bug 就是<strong>未讀訊息</strong>的數字不準確，因為很多的區塊都有可能會影響到未讀訊息的數字，所以要追蹤到底是哪個區塊造成的 bug 就變得非常困難，而 meta 每次遇到這個 bug 都是去解決那些 edge case (邊界案例)，沒有真的解決核心問題，所以導致每次新增功能都會有新的 bug 產生。</p>
<img src=/assets/images/fb-message-block-6ff5ff6f29dbc170f194443c2085f871.png style=width:min(100%,100%);display:inline-block;margin:0;border-radius:5px><br><br>
<p>他們認為這是因為 MVC 的雙向綁定造成的，當資料流變得越來越複雜時，就會變得非常難以追蹤，所以提出了 Flux 的<strong>單向資料流</strong>的架構。</p>
<p>Flux 將資料流的傳遞分為四個部分：</p>
<ol>
<li>Action：物件結構包含行為定義及傳遞的資訊</li>
<li>Dispatcher：負責分發 Action 的函式</li>
<li>Store：儲存資料及回應 Action 的行為</li>
<li>顯示 Store 提供的資料畫面</li>
</ol>
<img src=/assets/images/flux-flow-61e705f06287ccfbaa6e59f5b958145b.png style=width:min(100%,100%);display:inline-block;margin:0;border-radius:5px><br><br>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=redux>Redux<a href=#redux class=hash-link aria-label=Redux的直接連結 title=Redux的直接連結>​</a></h3>
<p>在提出 Flux 架構的同時，meta 也提出了一個叫 <a href=https://facebookarchive.github.io/flux/ target=_blank rel="noopener noreferrer">Flux</a> 的 library，不過並沒有受到太多的關注，直到隔一年 Dan Abramov 提出了基於 Flux 概念實作的 library <a href=https://redux.js.org/ target=_blank rel="noopener noreferrer">Redux</a>，這個 library 後來成為了 React 最受歡迎的狀態管理 library 之一。</p>
<p>在 Redux 的<a href=https://redux.js.org/tutorials/fundamentals/part-2-concepts-data-flow#redux-application-data-flow target=_blank rel="noopener noreferrer">官網</a>可以明確的看到整個 redux 的資料流：</p>
<img src=/assets/images/redux-flow-49fa8c3968371d9ef6f2a1486bd40a26.gif style=width:min(100%,100%);display:inline-block;margin:0;border-radius:5px><br><br>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=總結>總結<a href=#總結 class=hash-link aria-label=總結的直接連結 title=總結的直接連結>​</a></h2>
<p>其實光看 Flux 及 Redux 的圖，會覺得好像跟 MVC 沒有什麼差別，也是定義個別的職責，View 跟 Model 分開，也有類似 controller 的東西。不過重點在於它更加嚴謹的定義了資料流的方向，讓資料更好的統一，雖然 MVC 架構也辦得到這件事，但並不是每個人都會這麼做，所以我認爲 Flux 還是跟 MVC 有所區別。</p>
<p>回到 zustand，之所以能夠寫的那麼簡潔方邊使用，是因為他並不是完全的實作了 Flux，他捨棄了 Flux 中的 Action 及 Dispatcher，只保留了 Store 的部分，在 DX (Developer Experience) 上的體驗就比較好，而雖然不是嚴謹的 Flux 架構，但還是遵循著最基本的單向資料流的原則，讓我們可以更好的進行管理狀態。</p>
<p>總而言之，如果不想使用 React 原生的 useContext，而學習 Redux 的入門又有點太高，zustand 是一個很好的選擇，在做 side project 或是小型專案絕對是非常夠用的，而且也可以讓你對狀態管理有更深的了解！</p>
<p>有任何問題或是內容有誤的地方，歡迎在底下留言 ~</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=參考資料>參考資料<a href=#參考資料 class=hash-link aria-label=參考資料的直接連結 title=參考資料的直接連結>​</a></h2>
<ul>
<li><a href=https://medium.com/%E6%89%8B%E5%AF%AB%E7%AD%86%E8%A8%98/a-comparison-of-react-state-management-libraries-ba61db07332b target=_blank rel="noopener noreferrer">React 狀態管理套件比較與原理實現 feat. Redux, Zustand, Jotai, Recoil, MobX, Valtio</a></li>
<li><a href=https://juejin.cn/post/7178318352174022717 target=_blank rel="noopener noreferrer">是时候放弃 redux 了，zustand 是完美替代者（主要是源码分析）</a></li>
<li><a href=https://medium.com/wix-engineering/the-rise-of-flux-how-facebooks-shift-away-from-mvc-led-to-a-new-era-of-ui-architecture-61d78b4377b0 target=_blank rel="noopener noreferrer">The Rise of Flux: How Facebook’s Shift Away from MVC Led to a New Era of UI Architecture</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class=col><b>標籤：</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a class="tag_d0Lz tagRegular_bmnp" href=/tags/react>React</a><li class=tag_QGVx><a class="tag_d0Lz tagRegular_bmnp" href=/tags/zustand>Zustand</a><li class=tag_QGVx><a class="tag_d0Lz tagRegular_bmnp" href=/tags/source-code>Source Code</a></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated>最後<!-- -->於 <b><time datetime=2025-02-04T08:24:03.000Z itemprop=dateModified>2025年2月4日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label=文件選項卡><a class="pagination-nav__link pagination-nav__link--prev" href=/react/zustand><div class=pagination-nav__sublabel>上一頁</div><div class=pagination-nav__label>Zustand</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/category/typescript><div class=pagination-nav__sublabel>下一頁</div><div class=pagination-nav__label>TypeScript</div></a></nav></div><br></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#原始碼解析 class="table-of-contents__link toc-highlight">原始碼解析</a><ul><li><a href=#create-reactts class="table-of-contents__link toc-highlight">create (react.ts)</a><li><a href=#createstore-vanillats class="table-of-contents__link toc-highlight">createStore (vanilla.ts)</a><li><a href=#usestore-reactts class="table-of-contents__link toc-highlight">useStore (react.ts)</a><li><a href=#usesyncexternalstore class="table-of-contents__link toc-highlight">useSyncExternalStore</a><li><a href=#zustand-內部訂閱流程圖 class="table-of-contents__link toc-highlight">zustand 內部訂閱流程圖</a><li><a href=#zustand-更新-state-流程圖 class="table-of-contents__link toc-highlight">zustand 更新 state 流程圖</a></ul><li><a href=#zustand-濃縮版 class="table-of-contents__link toc-highlight">zustand 濃縮版</a><li><a href=#zustand-架構模式 class="table-of-contents__link toc-highlight">zustand 架構模式</a><ul><li><a href=#flux class="table-of-contents__link toc-highlight">Flux</a><li><a href=#redux class="table-of-contents__link toc-highlight">Redux</a></ul><li><a href=#總結 class="table-of-contents__link toc-highlight">總結</a><li><a href=#參考資料 class="table-of-contents__link toc-highlight">參考資料</a></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2025 Jim's note, Inc. Built with Docusaurus.</div></div></div></footer></div>