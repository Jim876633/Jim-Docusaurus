---
title: ã€JavaScriptã€‘è¶…å¥½ç”¨çš„ Web API - Intersection Observer
sidebar_label: Intersection Observer
tags: [javascript, coderbridge]
---

import CodePen from "@site/src/components/CodePen.jsx";

å…ˆä¾†çœ‹ä¸€ä¸‹æ•ˆæœï¼š

<CodePen slugHash="JjLOBVE" title="Intersection Observer" />

æ˜¯ä¸æ˜¯å¾ˆé…·ï¼ï¼

ä¹‹å‰è¦åœ¨æ»¾å‹•é é¢åšæ•ˆæœæ™‚ï¼Œéƒ½æ˜¯ç›£è½ `scroll` äº‹ä»¶ï¼Œæ­é…å–å¾—å…ƒç´ çš„ `Element.getBoundingClientRect()` æˆ–æ˜¯ `offsetTop` ã€ `offsetLest` å»å¯¦ç¾ï¼Œä¸åƒ…è¦è¨ˆç®—å…ƒç´ åˆ°æœ€è¦–çª—çš„è·é›¢ï¼Œè€Œä¸”æ¯æ»‘å‹•ä¸€æ¬¡å°±ç›£è½ä¸€æ¬¡ï¼Œå¾ˆå®¹æ˜“é™ä½è™•ç†æ•ˆèƒ½ï¼Œæ‰€ä»¥å–è€Œä»£ä¹‹çš„å°±æ˜¯ä»Šå¤©çš„ä¸»é¡Œ **Intersection Observer API** ã€‚

## Intersection Observer

> MDNï¼šThe IntersectionObserver interface of the Intersection Observer API provides a way to asynchronously observe changes in the intersection of a target element with an ancestor element or with a top-level document's viewport. The ancestor element or viewport is referred to as the root.

ç°¡å–®ä¾†èªªï¼Œ`Intersection Observer` å°±æ˜¯è§€å¯Ÿï¼ˆobserveï¼‰ç•¶**æŒ‡å®šå…ƒç´ **æ¥è§¸åˆ°**çˆ¶å±¤ä»¥ä¸Š**æˆ–è€…æ˜¯**è¦–çª—**çš„æ–¹æ³•ã€‚

## èªæ³•ï¼š

```js
const observer = new IntersectionObserver(callback, option);
observer.observe(element);
```

`IntersectionObserver` æ˜¯ä¸€å€‹å»ºæ§‹å‡½å¼ï¼Œæ‰€ä»¥éœ€è¦ `new` é—œéµå­—ä¾†å»ºç«‹å¯¦é«”ï¼Œå‡½å¼å…§å‚³å…¥å…©å€‹åƒæ•¸ï¼Œ**callback function** ä»¥åŠ **option** ï¼Œè§€æ¸¬çš„å…ƒç´ å‰‡ç”¨ `observer.observe(element)` ï¼Œä¾†è§€æ¸¬æŒ‡å®šå…ƒç´ ã€‚

### ğŸ“Œ option

å…ˆä¾†ä»‹ç´¹ **option** ï¼Œå®ƒæ˜¯ `IntersectionObserver` çš„**å±¬æ€§ï¼ˆpropertyï¼‰**ï¼Œå¯ä»¥åˆ¤æ–·æŒ‡å®šå…ƒç´ èˆ‡çª—å£çš„äº¤æ¥æ¢ä»¶ã€‚

```js
const option = {
  root: null,
  rootMargin: "0px 0px 0px 0px",
  threshold: 0.0,
};
```

**option** æœ‰ä¸‰å€‹å±¬æ€§ï¼š

- **rootï¼š**æŒ‡å®šèˆ‡å…ƒç´ äº¤æ¥çš„çª—å£ï¼Œé è¨­ç‚º `Null`ï¼Œæ˜¯ä»¥ **Viewpoint**ç•¶ä½œçª—å£ã€‚

- **rootMarginï¼š**å¯ä»¥èª¿æ•´æŒ‡å®šçª—å£ç¸®æ”¾ï¼Œé †åºèˆ‡ CSS çš„ `margin` ä¸€æ¨£ï¼Œè€Œæ­£æ•¸ç‚ºå¤–æ“´ï¼Œè² æ•¸ç‚ºå…§ç¸®ã€‚

- **thresholdï¼š**å‰å…©å€‹éƒ½æ˜¯æ§åˆ¶å¤–å±¤å±¬æ€§ï¼Œå”¯ç¨é€™ä¸€å€‹æ˜¯æ§åˆ¶æŒ‡å®šå…ƒç´ çš„**äº¤æ¥ç¯„åœç™¾åˆ†æ¯”**ï¼Œæ•¸å€¼ä»‹æ–¼ 0 ~ 1ï¼Œè¨ˆç®—æ–¹å¼ç‚º **äº¤æ¥é¢ç© / å…ƒç´ é¢ç©** ã€‚

  - é è¨­å€¼ç‚º 0 ï¼ŒæŒ‡çš„æ˜¯ç•¶å…ƒç´ èˆ‡çª—å£äº¤æ¥ç¯„åœ**å¤§æ–¼ 0%**ï¼Œæˆ–**å°æ–¼ 0%** çš„ç¬é–“è§¸ç™¼ã€‚
  - ç•¶è¨­å®šç‚º 1 ï¼ŒæŒ‡çš„æ˜¯ç•¶å…ƒç´ èˆ‡çª—å£äº¤æ¥ç¯„åœ**å¤§æ–¼ 100%** ï¼Œæˆ–æ˜¯å°æ–¼ **100%** çš„ç¬é–“è§¸ç™¼ã€‚
  - å¦‚æœè¦åœ¨ä¸åŒç¯„åœéƒ½è§¸ç™¼æ™‚ï¼Œå‰‡è¦ç”¨ `[0, 0.5, 1]` çš„æ–¹å¼æŠŠæ•¸å€¼åŒ…åœ¨é™£åˆ—è£¡ã€‚å¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•åšå‡ºä¸‹é¢çš„æ•ˆæœï¼š

<CodePen slugHash="yLKPxdM" title="Intersection Observer Threshold" />

### ğŸ“Œ Callback Function

```js
const callback = (entries, owner) => {
  console.log(owner);
  console.log(entry);
};
```

å‚³å…¥å…©å€‹åƒæ•¸ï¼ˆentries, ownerï¼‰ï¼š

- **entriesï¼š**æŒ‡çš„æ˜¯ä¸€å€‹åŒ…è‘— `IntersectionObserverEntry` ç‰©ä»¶çš„é™£åˆ—ï¼Œå¦‚æœè§€å¯Ÿå¤šå€‹å…ƒç´ å‰‡æœƒæœ‰å¤šå€‹ `IntersectionObserverEntry` ç‰©ä»¶ï¼Œå®ƒæœ‰å¾ˆå¤šå¥½ç”¨çš„å±¬æ€§ï¼Œå¯ä»¥ç”¨ä¾†è¨­å®šåŸ·è¡Œæ•ˆæœçš„æ¢ä»¶ï¼Œä¸‹é¢æœƒé€²ä¸€æ­¥ç´°è¬›ã€‚

![](https://static.coderbridge.com/img/Jim876633/f08e257f715041a39dd58398ef312627.jpg)

- **ownerï¼š**æŒ‡çš„æ˜¯ `IntersectionObserver` çš„å¯¦é«”ï¼Œä¹Ÿå°±æ˜¯ callback function çš„ `this`ã€‚

### ğŸ“Œ IntersectionObserverEntry property

![](https://static.coderbridge.com/img/Jim876633/43ab7968b5264b288d826501ac71c442.jpg)

- boundingClientRectï¼šèˆ‡ `Element.getBoundingClientRect()` å›å‚³çš„è³‡è¨Šä¸€æ¨£ï¼Œå›å‚³å…ƒç´ çš„é•·å¯¬åŠç›¸å°æ–¼**è¦–çª—**çš„åº§æ¨™è³‡è¨Šã€‚

- intersectionRatioï¼šèˆ‡ `threshold` çš„åŠŸèƒ½ä¸€æ¨£ï¼Œå›å‚³ 0 ~ 1 çš„æ•¸ï¼Œç‚ºäº¤æ¥é¢ç© / å…ƒç´ é¢ç©ã€‚

- isIntersectingï¼ˆbooleanï¼‰ï¼šå¸¸ç”¨å±¬æ€§ï¼Œåˆ¤æ–·å…ƒç´ æ˜¯å¦é€²å…¥çª—å£ç¯„åœã€‚

- rootBoundsï¼šèˆ‡å‰é¢çš„ `boundingClientRect` ä¸€æ¨£æ˜¯å…ƒç´ è³‡è¨Šï¼Œå·®åˆ¥åœ¨æ–¼å›å‚³çš„æ˜¯**çª—å£**ï¼Œçš„å…ƒç´ è³‡è¨Šã€‚

- targetï¼šäº¤æ¥çš„æŒ‡å®šç›®æ¨™å…ƒç´ ã€‚

- timeï¼šå›å‚³é–‹å§‹è§€æ¸¬å¾Œçš„æ™‚é–“ã€‚

### ğŸ“Œ IntersectionObserver method

é™¤äº†ä¸€é–‹å§‹æåˆ°çš„ `IntersectionObserver.observe(element)` ä¾†æŒ‡å®šå…ƒç´ ï¼Œé‚„æœ‰å¹¾å€‹å¯ç”¨çš„ methodã€‚

- **IntersectionObserver.observe(element)ï¼š** å‘Šè¨´è§€æ¸¬è€…æŒ‡å®šç›®æ¨™å…ƒç´ æ˜¯èª°ã€‚

- **IntersectionObserver.unobserve(element)ï¼š** å‘Šè¨´è§€æ¸¬è€…ä¸å†è§€æ¸¬æŒ‡å®šç›®æ¨™å…ƒç´ ã€‚

- **IntersectionObserver.disconnectï¼š** å‘Šè¨´è§€æ¸¬è€…ä¸å†è§€æ¸¬ä»»ä½•æŒ‡å®šç›®æ¨™å…ƒç´ ã€‚

## æ‡‰ç”¨

æœ€å¸¸çš„ä½¿ç”¨æ™‚æ©Ÿæœ‰å…©å€‹ï¼Œä¸€å€‹æ˜¯å»¶é²è¼‰å…¥ï¼ˆLazy Loadingï¼‰ï¼Œå¦ä¸€å€‹æ˜¯ç„¡é™æ»¾å‹•ï¼ˆInfinite Scrollï¼‰ï¼Œçš†æ˜¯ç‚ºäº†å„ªåŒ–**è®€å–é€Ÿåº¦**ï¼Œèƒ½åœ¨æ»‘å‹•åˆ°æŒ‡å®šä½ç½®æ™‚ï¼Œæ‰è¼‰å…¥è³‡æºã€‚

### ğŸ“Œ å»¶é²è¼‰å…¥ï¼ˆlazy Loadingï¼‰

<CodePen slugHash="zYWPMXr" title="Intersection Observer Lazy Loading" />

_æ–¹æ³•ï¼š_

ç•¶å…ƒç´ çš„ä¸€åŠé€²å…¥è¦–çª—æ™‚ï¼Œæ‰è¼‰å…¥åœ–ç‰‡ï¼Œé›¢é–‹åˆ°å…ƒç´ çš„ä¸€åŠæ™‚ï¼Œå‰‡ç§»é™¤åœ–ç‰‡ã€‚ä¹Ÿå¯ä»¥åšå‡º **Fade in ã€ Fade out** çš„æ•ˆæœï¼

### ğŸ“Œ ç„¡é™æ»¾å‹•ï¼ˆInfinite Scrollï¼‰

<CodePen slugHash="WNzXLOe" title="Intersection Observer Infinite Scroll" />

_æ–¹æ³•ï¼š_

```js
function addList() {
  const li = document.querySelector("li:nth-child(1)");
  const html = Array(10).fill(`<li>${li.textContent}<hr></li>`).join("");
  document.querySelector("ul").innerHTML += html;
}
const callback = (entries) => {
  if (entries[0].isIntersecting) {
    addList();
    //ç§»é™¤è§€æ¸¬èˆŠçš„å…ƒç´ ï¼Œè§€æ¸¬æ–°çš„å…ƒç´ 
    observer.unobserve(entries[0].target);
    observer.observe(document.querySelector("li:nth-last-child(2)"));
  }
};
const observer = new IntersectionObserver(callback);
observer.observe(document.querySelector("li:nth-last-child(2)"));
```

ç•¶æ¸…å–®çš„å€’æ•¸ç¬¬äºŒé …é€²å…¥è¦–çª—æ™‚ï¼Œå°±åŸ·è¡Œ `addItem()` æ–°å¢åé …æ¸…å–®ï¼Œæ–°å¢çš„æ–¹å¼æ˜¯å»ºç«‹ä¸€å€‹ 10 å€‹é …ç›®çš„é™£åˆ— `Array(10).fill(html)` æŠŠæ¸…å–®çš„ HTML ä¸Ÿé€²å»ï¼Œä¸¦åŠ å…¥åˆ°èˆŠæœ‰çš„æ¸…å–®è£¡ã€‚

åŸ·è¡Œå®Œå¾Œè¦è¨˜å¾—æŠŠåŸæœ¬è§€å¯Ÿçš„é …ç›®ç§»é™¤ï¼Œå†é‡æ–°è§€å¯Ÿæ–°çš„ list çš„å€’æ•¸ç¬¬äºŒé …ï¼Œå°±å¯ä»¥ç„¡é™æ»¾å‹•æ–°å¢æ¸…å–®ï¼

## åƒè€ƒ

[èªè­˜ Intersection Observer APIï¼šå¯¦ä½œ Lazy Loading å’Œ Infinite Scroll](https://medium.com/%E9%BA%A5%E5%85%8B%E7%9A%84%E5%8D%8A%E8%B7%AF%E5%87%BA%E5%AE%B6%E7%AD%86%E8%A8%98/%E8%AA%8D%E8%AD%98-intersection-observer-api-%E5%AF%A6%E4%BD%9C-lazy-loading-%E5%92%8C-infinite-scroll-c8d434ad218c)
[é‚£äº›è¢«å¿½ç•¥ä½†å¾ˆå¥½ç”¨çš„ Web API / IntersectionObserver](https://ithelp.ithome.com.tw/articles/10279046)
