---
title: "[Day 06] React Testing Library èªæ³•ä»‹ç´¹"
tags: ["ITHome 2023"]
---

å‰é¢æåˆ° Jest æœ¬èº«æœ‰æä¾›å¾ˆå¤šæ¸¬è©¦æ–¹æ³•ï¼Œä½†åœ¨æ¸¬è©¦ä¸Šéƒ½æ¯”è¼ƒåå‘é‚è¼¯æ¸¬è©¦ï¼Œåƒæ˜¯ a + b æ˜¯å¦ç­‰æ–¼ cã€‚è€Œå¯¦éš›ä¸Šæˆ‘å€‘æ‰€éœ€è¦çš„æ¸¬è©¦æœ‰ä¸€å¤§éƒ¨åˆ†ä¹ŸåŒ…å« UI çš„æ¸¬è©¦ï¼Œåƒæ˜¯ç•«é¢ä¸Šæœ‰æ²’é¡¯ç¤ºæ­£ç¢ºæ–‡å­—ï¼Œæˆ–æ˜¯ä½¿ç”¨è€…é»æ“Šæœ‰æ²’æœ‰è·³å‡ºè¦–çª—ç­‰ç­‰ï¼Œé€™æ™‚å€™å°±éœ€è¦ä½¿ç”¨ Testing Library ã€‚

Testing Library [æ–‡æª”ä»‹ç´¹](https://testing-library.com/docs/)é–‹é ­å°±å¾ˆæ˜ç¢ºçš„èªªäº†

> The @testing-library family of packages helps you test UI components in a user-centric way.

ä¹Ÿå°±æ˜¯ @testing-library ç³»åˆ—çš„å¥—ä»¶å¯ä»¥å¹«åŠ©ä½ ä»¥ç”¨æˆ¶ç‚ºä¸­å¿ƒçš„æ–¹å¼æ¸¬è©¦ UI å…ƒä»¶ã€‚

Testing Library ä¸åªæä¾›å¯ä»¥å…±é€šä½¿ç”¨çš„æ¸¬è©¦å¥—ä»¶ï¼Œé‚„æœ‰å°ˆç‚ºå„å€‹æ¡†æ¶æ‰€å‡ºçš„å¥—ä»¶ï¼ŒåŸºæœ¬çš„ä¸‰å¤§æ¡†æ¶ Reactã€Vueã€Angular éƒ½æœ‰å±¬æ–¼ä»–å€‘çš„æ¸¬è©¦ UI å¥—ä»¶ã€‚è€Œæ¯”è¼ƒæ–°çš„æ¡†æ¶åƒæ˜¯ Preactã€Svelte ä¹Ÿéƒ½æœ‰åœ¨æŒçºŒæ›´æ–°ã€‚

## Testing Library For React

ä»¥ React ä¾†èªªï¼Œæ­é… Jest æœƒéœ€è¦çš„ Testing Libary æœ‰ä»¥ä¸‹å¹¾å€‹ï¼š

1. [@testing-library/react](https://www.npmjs.com/package/@testing-library/react) - æ¨¡æ“¬ React æ¸²æŸ“ï¼ŒExï¼šrenderã€screen

2. [@testing-library/jest-dom](https://www.npmjs.com/package/@testing-library/jest-dom) - æ“´å…… jest çš„æ–·è¨€åº«ï¼ŒExï¼štoBeInTheDocumentã€toHaveClass

3. [@testing-library/user-event](https://www.npmjs.com/package/@testing-library/user-event) - æ¨¡æ“¬ä½¿ç”¨è€…æ“ä½œï¼ŒExï¼šuseEvent.clickã€userEvent.type

æ¥ä¸‹ä¾†ä¾†å„åˆ¥ä»‹ç´¹é€™ä¸‰å€‹çš„ä½¿ç”¨æ™‚æ©Ÿï¼š

### ğŸ“Œ @testing-library/react

ä¸»è¦æ˜¯æä¾›æ¨¡æ“¬æ¸²æŸ“ UI ç•«é¢çš„å‡½å¼ï¼Œæ¯”è¼ƒå¸¸ç”¨çš„æœ‰

1. `render()`

å°±å¦‚åŒ React ä¸­çš„ renderï¼Œå°±æ˜¯æ¨¡æ“¬æ¸²æŸ“ React å…ƒä»¶ï¼Œå‡è¨­æœ‰ä¸€å€‹ `<Home/>` å…ƒä»¶ï¼š

```js
export const Home = () => {
  return <h1>Home Page</h1>;
};
```

è¦æ¸¬è©¦å…ƒä»¶çš„ DOM å…ƒç´ æ™‚ï¼Œå°±å¯ä»¥ä½¿ç”¨ `render()` å‡½å¼ã€‚

```js
import { render } from "@testing-library/react";
import { Home } from "./Home";

describe("testing home component", () => {
  it("show Home Page in the home component", () => {
    const { getByText } = render(<Home />);
    //ä½¿ç”¨ getByText åˆ¤æ–·æŠ“åˆ°æ–‡å­—çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
    expect(getByText("Home Page")).toBeTruthy();
  });
});
```

`render()` å‡½å¼æœƒå›å‚³ä¸€å€‹ç‰©ä»¶åŒ…å«ä¸€äº›å±¬æ€§å°è±¡ï¼š

- [...Query](https://testing-library.com/docs/queries/about/)ï¼šgetByã€queryByã€findByã€getAllByã€queryAllByã€findAllByï¼Œå–å¾—å…ƒä»¶å…§çš„å…ƒç´ ã€‚
- containerï¼šæ¸²æŸ“çš„ DOM ç¯€é»ã€‚
- debugï¼šåµéŒ¯å‡½å¼ï¼Œå¯ä»¥é¡¯ç¤ºç•¶å‰çš„ DOM çµæ§‹ã€‚
- rerenderï¼šé‡æ–°æ¸²æŸ“å…ƒä»¶ã€‚
- unmountï¼šå–æ¶ˆæ¸²æŸ“ã€‚

Query æœ‰å¾ˆå¤šä¸åŒçš„å–å…ƒç´ æ–¹æ³•ï¼Œæœ‰ getã€findã€queryï¼Œå„è‡ªéƒ½æœ‰å–å¾—å¤šå…ƒç´ çš„ all æ–¹æ³•

| Query ç¨®é¡\çµæœ | æ²’æœ‰ç¬¦åˆ    | ä¸€é …ç¬¦åˆ     | å¤šé …ç¬¦åˆ     | æ˜¯å¦ç‚ºéåŒæ­¥å‡½å¼ |
| :-------------: | ----------- | ------------ | ------------ | ---------------- |
|    getBy...     | Throw Error | å›å‚³å…ƒç´      | Throw Error  | âŒ               |
|   queryBy...    | å›å‚³ `null` | å›å‚³å…ƒç´      | Throw Error  | âŒ               |
|    findBy...    | Throw Error | å›å‚³å…ƒç´      | å›å‚³å…ƒç´      | âœ…               |
|   getAllBy...   | Throw Error | å›å‚³å…ƒç´ é™£åˆ— | å›å‚³å…ƒç´ é™£åˆ— | âŒ               |
|  queryAllBy...  | å›å‚³ `[]`   | å›å‚³å…ƒç´ é™£åˆ— | å›å‚³å…ƒç´ é™£åˆ— | âŒ               |
|  findAllBy...   | Throw Error | å›å‚³å…ƒç´ é™£åˆ— | å›å‚³å…ƒç´ é™£åˆ— | âœ…               |

çœ‹èµ·ä¾†å¾ˆå®¹æ˜“ææ··ï¼Œä¸éä»–å€‘éƒ½æœ‰å„è‡ªä½¿ç”¨çš„æ™‚æ©Ÿ

- getBy...ï¼šå¤§éƒ¨åˆ†éƒ½å¯ä»¥ä½¿ç”¨ï¼Œåˆ¤æ–·å…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚
- queryBy...ï¼šå› ç‚ºæ‰¾ä¸åˆ°æœƒå›å‚³ null çš„ç‰¹æ€§ï¼Œæ‰€ä»¥å¸¸ç”¨ä¾†åˆ¤æ–·å…ƒç´ æ˜¯å¦ä¸€é–‹å§‹ä¸å­˜åœ¨ã€‚
- findBy...ï¼šéåŒæ­¥å‡½å¼ï¼Œå¯ä»¥åˆ¤æ–·éœ€ç­‰å¾…çš„å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œä¾‹å¦‚ API å›å‚³æ‰æœƒé¡¯ç¤ºåœ¨ç•«é¢ä¸Šã€‚

2. `screen()`

é›–ç„¶ `render()` è§£æ±ºäº†æ¨¡æ“¬ UI çš„æƒ…æ³ï¼Œä¸éåªèƒ½æ ¹æ“š `render()` çš„å…§å®¹é€²è¡Œæ¸¬è©¦ï¼Œå¦‚æœæœ‰å¤šå€‹ `render()` å‡½å¼æ¸¬èµ·ä¾†å°±æœƒæ¯”è¼ƒéº»ç…©ï¼Œé€™æ™‚å€™å°±å¯ä»¥ä½¿ç”¨ `screen()`ã€‚

å…¶å¯¦ `screen()` ç®—æ˜¯ @testing-library/dom æ‰€æä¾›ï¼Œè€Œæ‰€æœ‰æ¡†æ¶çš„ @testing-library åº•å±¤éƒ½æœ‰ @testing-library/domï¼Œæ‰€ä»¥é€™é‚Šæ‰å¯ä»¥ç›´æ¥åšä½¿ç”¨ã€‚

è€Œ `screen()` æ‰€æŠ“å–çš„å…ƒç´ æ˜¯ `<body></body>` å…§çš„æ‰€æœ‰ DOM å…ƒç´ ã€‚

```js
import { render, screen } from "@testing-library/react";
import { Home } from "./Home";

describe("testing home component", () => {
  it("show Home Page in the home component", () => {
    render(<Home />);
    render(<Home />);
    //ä½¿ç”¨ getAllByText åˆ¤æ–·æ˜¯å¦æŠ“å–å…©å€‹å…ƒç´ 
    expect(screen.getAllByText("Home Page")).toHaveLength(2);
  });
});
```

å€‹äººåœ¨æŠ“å…ƒç´ æ™‚æ˜¯æ¯”è¼ƒå¸¸ç”¨ `screen()` å‹éæ–¼ä½¿ç”¨ `render()` å›å‚³çš„æ–¹æ³•ï¼Œä½¿ç”¨èµ·ä¾†ä¹Ÿæ¯”è¼ƒæ–¹ä¾¿ã€‚

3. `renderHook()`

é¡§åæ€ç¾©å°±æ˜¯å»æ¨¡æ“¬å®¢è£½åŒ–çš„ React Hookï¼Œå‡è¨­ä»Šå¤©æœ‰ä¸€å€‹è¨ˆæ•¸å™¨çš„ custom hook

```js
import { useState } from "react";

function useCounter(initialValue = 0) {
  const [count, setCount] = useState(initialValue);
  // åŠ ä¸€å‡½å¼
  const increment = () => {
    setCount(count + 1);
  };
  // æ¸›ä¸€å‡½å¼
  const decrement = () => {
    setCount(count - 1);
  };

  return { count, increment, decrement };
}

export default useCounter;
```

è¦æ¸¬è©¦é€™å€‹ hook å°±å¯ä»¥ä½¿ç”¨ `renderHook()`ï¼Œä»–å¯ä»¥å‚³å…¥å…©å€‹åƒæ•¸ï¼Œç¬¬ä¸€å€‹å°±æ˜¯è¦æ¸¬è©¦çš„å‡½å¼ï¼Œç¬¬äºŒæ˜¯å‚³å…¥å‡½å¼çš„åƒæ•¸ (éå¿…è¦)ã€‚

```js
import useCounter from "./useCounter";
import { renderHook, act } from "@testing-library/react";

it("should increment and decrement the counter", () => {
  const { result } = renderHook(useCounter);

  expect(result.current.count).toBe(0);

  act(() => {
    result.current.increment(); // å‘¼å« + 1 å‡½å¼
  });

  expect(result.current.count).toBe(1);

  act(() => {
    result.current.decrement(); // å‘¼å« -1 å‡½å¼
  });

  expect(result.current.count).toBe(0);
});
```

`renderHook()` æœƒå›å‚³ä¸€å€‹ç‰©ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ result å±¬æ€§åˆ©ç”¨ result.current å»æ“æ§å‡½å¼çš„å›å‚³ç‰©ä»¶ã€‚

å¦‚æœæœ‰**æ›´æ”¹ state** çš„æ“ä½œï¼Œå°±éœ€è¦ä½¿ç”¨ **act** åŒ…èµ·ä¾†ï¼Œé€™æ¨£æ‰å¯ä»¥å³æ™‚æ›´æ–° state çš„ç‹€æ…‹ã€‚

### ğŸ“Œ @testing-library/jest-dom

@testing-library/jest-dom æä¾›çµ¦ Jest å¾ˆå¤š DOM å…ƒç´ çš„æ“´å……åˆ¤æ–·ï¼Œè®“æˆ‘å€‘åœ¨æŠ“å…ƒç´ æ™‚ï¼Œæœ‰æ›´å¤šçš„æ–¹æ³•å»æ¸¬è©¦ï¼Œæ¯”è¼ƒå¸¸ç”¨çš„åƒæ˜¯ `toBeInTheDocument`ã€`toHaveClass` ç­‰ç­‰ã€‚

ä»¥å‰›å‰›çš„ `<Home/>` æ¸²æŸ“æ¸¬è©¦ç‚ºä¾‹

```js
import { render, screen } from "@testing-library/react";

describe("testing home component", () => {
  it("show Home Page in the home component", () => {
    render(<Home />);
    expect(screen.getByText("Home Page")).toBeInTheDocument(); // åˆ¤æ–·å…ƒç´ æ˜¯å¦å­˜åœ¨æ–¼ DOM ä¸­
  });
});
```

æˆ–æ˜¯

```js
import { render, screen } from "@testing-library/react";

describe("testing div", () => {
  it("test div className have 'hide'", () => {
    render(<div className='hide'>test</div>);
    expect(screen.getByText("test")).toHaveClass("hide"); //åˆ¤æ–·å…ƒç´ æ˜¯å¦å«æœ‰æŒ‡å®šçš„ class name
  });
});
```

### ğŸ“Œ @testing-library/user-event

æœ€å¾Œä¸€å€‹å°±æ˜¯æ¨¡æ“¬ä½¿ç”¨è‘—æ“ä½œï¼Œuser-event å¸¸å¸¸è·Ÿå¦ä¸€å€‹ @testing-library/react çš„ fireEvent æ‹¿ä¾†æ¯”è¼ƒï¼ŒfireEvent å°±æ˜¯åœ¨ç¨‹å¼ç¢¼ä¸­æœƒç”¨çš„äº‹ä»¶è™•ç†ï¼Œåƒæ˜¯ click æˆ–æ˜¯ changeï¼Œè€Œ user-event çš„åº•å±¤å°±æ˜¯ fireEventï¼Œä¸é userEvent èƒ½æ›´è²¼åˆä½¿ç”¨è€…çš„æ¨¡æ“¬æƒ…æ³ï¼Œåƒæ˜¯åŒæ¨£æ˜¯åœ¨ input è¼¸å…¥æ–‡å­—ï¼Œå¦‚æœä½¿ç”¨ fireEvent å°±æœƒä½¿ç”¨ change çš„äº‹ä»¶ã€‚

**fireEventï¼š**

```js
import { fireEvent } from "@testing-library/react";

fireEvent.change(inputElement, { target: { value: "Hello World!" } });
```

ä¸éå¦‚æœæ˜¯ä½¿ç”¨ userEvent å°±æœƒä½¿ç”¨ type çš„äº‹ä»¶ã€‚

**userEventï¼š**

```js
import userEvent from "@testing-library/user-event";

const user = userEvent.setup();
await user.type(inputElement, "Hello World!");
```

é™¤äº† userEvent æ˜¯éåŒæ­¥ä»¥å¤–ï¼Œä¹çœ‹ä¹‹ä¸‹æ²’æœ‰ä»€éº¼ä¸ä¸€æ¨£ï¼Œä¸é userEvent çš„ type é‚„åŒ…å«ä½¿ç”¨è€…é»æ“Š inputï¼Œè¼¸å…¥æ–‡å­—çš„ keyDownã€keyUp äº‹ä»¶ï¼Œæ¯”èµ· fireEvent çš„ changeï¼Œæ›´è²¼è¿‘å¯¦éš›çš„ä½¿ç”¨è€…æ“ä½œæƒ…æ³ã€‚

å‡è¨­æœ‰ä¸€å€‹ inputï¼Œè¼¸å…¥æ–‡å­—çš„åŒæ™‚æœƒé¡¯ç¤º KeyDownã€KeyUp çš„æ–‡å­—

```js
import React, { useState } from "react";

function KeyEvent() {
  const [text, setText] = useState("");
  const [keyEvent, setKeyEvent] = useState("");

  // keyDown äº‹ä»¶
  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    setKeyEvent((prev) => prev + `Key Down: ${e.key}`);
  };
  // keyUp äº‹ä»¶
  const handleKeyUp = (e: React.KeyboardEvent<HTMLInputElement>) => {
    setKeyEvent((prev) => prev + `Key Up: ${e.key}`);
  };

  return (
    <div>
      <input
        type='text'
        value={text}
        onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
          setText(e.target.value)
        }
        onKeyDown={handleKeyDown}
        onKeyUp={handleKeyUp}
        data-testid='input'
      />
      <p data-testid='key-event'>{keyEvent}</p>
    </div>
  );
}

export default KeyEvent;
```

ä½¿ç”¨ firEvent ä¾†æ¸¬è©¦

```js
describe("KeyEventsComponent", () => {
  it("test with fireEvent", async () => {
    render(<KeyEvent />);
    const inputElement = screen.getByTestId("input");
    const keyEventElement = screen.getByTestId("key-event");

    // ä½¿ç”¨ fireEvent.change è¼¸å…¥æ–‡å­—
    fireEvent.change(inputElement, { target: { value: "Hello" } });

    // ä½¿ç”¨ fireEvent.keyDown æ¨¡æ“¬ä½¿ç”¨è€…æŒ‰ä¸‹ o
    fireEvent.keyDown(inputElement, { key: "o" });

    // ä½¿ç”¨ fireEvent.keyUp æ¨¡æ“¬ä½¿ç”¨è€…æ”¾é–‹ o
    fireEvent.keyUp(inputElement, { key: "o" });

    expect(inputElement).toHaveValue("Hello");
    expect(keyEventElement.textContent).toContain("Key Down: o");
    expect(keyEventElement.textContent).toContain("Key Up: o");
  });
});
```

å¯ä»¥çœ‹åˆ°éœ€è¦æŠŠ change äº‹ä»¶è·Ÿ keyDownã€keyUp äº‹ä»¶åˆ†é–‹å¯«ï¼Œå¯«èµ·ä¾†æ¯”è¼ƒéº»ç…©å¤–ï¼Œä¹Ÿä¸ç¬¦åˆå¯¦éš›çš„ä½¿ç”¨è€…è¼¸å…¥ã€‚

å¦‚æœä½¿ç”¨ userEvent ä¾†æ¸¬è©¦

```js
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import KeyEvent from "./KeyEvent";

const user = userEvent.setup();

describe("KeyEventsComponent", () => {
  it("should simulate key events with userEvent.type", async () => {
    render(<KeyEvent />);
    const inputElement = screen.getByTestId("input");
    const keyEventElement = screen.getByTestId("key-event");

    // ä½¿ç”¨ user.type è¼¸å…¥æ–‡å­—
    await user.type(inputElement, "Hello");

    // åˆ¤æ–· input çš„å€¼æ˜¯å¦ç‚º Hello
    expect(inputElement).toHaveValue("Hello");

    // åˆ¤æ–·æ˜¯å¦æœ‰é¡¯ç¤º KeyDownã€KeyUp çš„æ–‡å­—
    expect(keyEventElement.textContent).toContain("Key Down: o");
    expect(keyEventElement.textContent).toContain("Key Up: o");
  });
});
```

åªéœ€è¦ä¸€å€‹ user.type å°±å¯ä»¥åŒ…å«æ‰€æœ‰çš„äº‹ä»¶ï¼Œä¹Ÿæ›´è²¼è¿‘ä½¿ç”¨è€…çš„æ“ä½œã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒuserEvent é‚„æœ‰æä¾›å¾ˆå¤šå¯¦ç”¨çš„æ–¹æ³•åƒæ˜¯ï¼š

- dblClickï¼šé»æ“Šå…©æ¬¡

- tripleClickï¼šé»æ“Šä¸‰æ¬¡

- typeï¼šinput è¼¸å…¥

- uploadï¼šä¸Šå‚³

- hover/unhoverï¼šæŒ‡æ¨™ç§»é€²ç§»å‡º

- copy/pasteï¼šè¤‡è£½/è²¼ä¸Š

è©³ç´°çš„å¯ä»¥åƒè€ƒ [User Interactions](https://testing-library.com/docs/user-event/intro/)

ä»Šå¤©å°±ä»‹ç´¹åˆ°é€™é‚Šï½ä¸‹ä¸€ç¯‡çµ‚æ–¼è¦é€²å…¥ AI çš„éƒ¨åˆ†äº†ï¼
